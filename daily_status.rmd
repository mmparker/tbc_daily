


```{r setup, echo= FALSE, message=FALSE,warning= FALSE}

# Strings ain't factors
options(stringsAsFactors = FALSE)

# Load the required libraries
library(knitr)
library(xtable)
library(RODBC)
library(plyr)
library(ggplot2)
library(scales)
library(gridExtra)
library(lubridate)
library(reshape2)


# Set default chunk options
opts_chunk$set(echo = FALSE,
               results = 'asis',
               message = FALSE,
               warning = FALSE,
               fig.width = 10,
               error = TRUE)


# Set up default print arguments for printing tables:
# xtable() makes data.frames more suitable for display
# format() converts all of the data.frame comments to character*;
# print() writes the xtable object to HTML

# *print() for xtable throws a tantrum over Date and POSIXct variables,
# so they have to be converted to character before printing 

dfprint <- function(df, printdigits = 2) {
    print(
        xtable(format(df, 
                      na.encode = FALSE, 
                      digits = printdigits, 
                      nsmall = printdigits), 
               align = c("l", "l", rep("c", ncol(df) - 1))
        ),
        type = "html",
        include.rownames = FALSE,
        NA.string = "-")
}


# Set period dates
# Go twelve weeks back from the next Monday - this helps ensure that
# plotted weeks are full weeks. Otherwise, you might end up with just a Friday,
# which makes a given week look really slow.
next.seven <- seq(from = Sys.Date(), length.out = 7, by = "day")
start_date <- next.seven[format(next.seven, "%A") %in% "Monday"] - weeks(12)
stop_date <- Sys.Date()


# Set some default plot parameters
point_size <- 3
line_size <- 1.3
colorwheel <- c("#31A354", "#ADDD8E", "#F03B20", "#43A2CA")

theme_tb <- theme_bw() +
            theme(legend.key.width = unit(.75, "inches"))



# Set up the database connection
if(interactive()) { 
    plus <- odbcConnect("tbdbplus64")
    dbconnect <- "tbdbplus64"
} else {
    plus <- odbcConnect("tbdbplus32")
    dbconnect <- "tbdbplus32"
}




```






# TB Clinic Daily Status Report
Updated at `r paste(Sys.time())`

---------------------------------

## Recent Clinic Visits

```{r visits}


source("../Quarterly Strategic Area Review//R//fun/query_visits.r")

visits <- query_visits(start_date = start_date,
                       stop_date = stop_date,
                       odbc = dbconnect)

# Add a week indicator
visits$visit_week <- format(visits$visit_date, format = "%Y-%W")

# Aggregate by week
locagg <- ddply(subset(visits, location %in% c("Clinic", "Outreach")),
                .var = c("location", "visit_week"),
                .fun = summarise,
                n_visits = length(visit_date),
                week_date = as.Date(min(visit_date, na.rm = TRUE))
)


totals <- ddply(subset(visits, location %in% c("Clinic", "Outreach")),
                .var = "visit_week",
                .fun = summarise,
                n_visits = length(visit_date),
                week_date = as.Date(min(visit_date, na.rm = TRUE))
)


totals$location <- "All Visits"

visitagg <- rbind(locagg, totals)



ggplot(visitagg, aes(x = week_date, y = n_visits, group = location, color = location)) +
    geom_point(size = point_size) +
    geom_line(aes(linetype = location), size = line_size) +
    expand_limits(y = 0) +
    scale_x_date(breaks = date_breaks("1 week")) +
    scale_color_manual("Visit Location", values = colorwheel[1:3]) +
    scale_linetype_discrete("Visit Location") +
    labs(x = "Visit Week", 
         y = "Number of visits",
         title = "Patient Visits by Location") +
    theme_tb + theme(axis.text.x = element_text(angle = 70, hjust = 1.30, vjust = 1.3))



```


```{r, results='asis'}

# Cast visits wide
visits_wide <- dcast(visitagg, week_date ~ location, value.var = "n_visits")

# Pretty-print
names(visits_wide) <- c("Visit Week", "Total Visits", "Clinic Visits", "Outreach Visits")

dfprint(visits_wide)

```


-------------------------------------------
## Recent Screenings
```{r screens}

# Load the function
source("../Quarterly Strategic Area Review//R//fun/query_tests.r")

# Query test results for the period
tests <- query_tests(start_date = start_date,
                     stop_date = stop_date,
                       odbc = dbconnect)


# Add a week indicator
tests$test_week <- format(tests$test_date, format = "%Y-%W")


# Aggregate by week
testagg <- count(tests, vars = c("test", "test_week"))

testagg <- ddply(tests,
                .var = c("test", "test_week"),
                .fun = summarise,
                freq = length(test_date),
                week_date = as.Date(min(test_date, na.rm = TRUE))
)


# Plot it
ggplot(testagg, aes(x = week_date, y = freq, group = test, color = test)) +
    geom_point(size = point_size) +
    geom_line(aes(linetype = test), size = line_size) +
    expand_limits(y = 0) +
    scale_x_date(breaks = date_breaks("1 week")) +
    scale_color_manual("Diagnostic", values = colorwheel[1:3]) +
    scale_linetype_discrete("Diagnostic") +
    labs(x = "Diagnostic date", 
         y = "Number of diagnostics",
         title = "Screenings for Active and Latent Tuberculosis") +
    theme_tb + theme(axis.text.x = element_text(angle = 70, hjust = 1.30, vjust = 1.3))


```


```{r, results='asis'}

# Cast tests wide
tests_wide <- dcast(testagg, week_date ~ test, value.var = "freq")

# Pretty-print
names(tests_wide) <- c("Test Week", "CXRs", "QFTs", "TSTs")

dfprint(tests_wide)

```



## Current Contact Investigations

```{r investigations}

# Summarize the open contact investigations
investigations <- sqlQuery(plus, "
                           
    SELECT c.person_id, d.last_name, d.first_name,
           c.date_opened, c.reason_for, c.priority, c.lead_investigator
    FROM Contact_Investigation c LEFT OUTER JOIN Demos_View d
    ON c.person_id = d.person_id
    WHERE c.status = 'Open'
                           
")

# Summarize the contacts themselves
contacts <- sqlQuery(plus, "
  
    SELECT source_person_id, contact_person_id, priority, contact_status
    FROM Contact
                     
")

contact_sum <- ddply(contacts, .var = "source_person_id", .fun = summarise,
                     n_contacts = length(contact_person_id),
                     n_open = sum(contact_status %in% 1, na.rm = TRUE),
                     priority_one = sum(priority %in% 3, na.rm = TRUE),
                     priority_two = sum(priority %in% 2, na.rm = TRUE),
                     priority_three = sum(priority %in% 1, na.rm = TRUE)
)


# Merge contact info onto investigation info
invest_sum <- merge(x = investigations,
                    y = contact_sum,
                    by.x = "person_id",
                    by.y = "source_person_id",
                    all.x = TRUE)


# Convert it all to character for better printing
invest_print <- data.frame(lapply(invest_sum, as.character))

dfprint(arrange(invest_print, lead_investigator, date_opened))

```



## Patients currently receiving treatment for Active TB


## Patients currently receiving treatment for LTBI



## Upcoming DOTs


## Upcoming LTBI Pickups


## CXRs Awaiting Action


## Upcoming Eight-Week Sputa











```{r cleanup}

# Close the database connection
odbcClose(plus)


```




