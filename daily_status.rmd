
<head>
<link rel="stylesheet" type="text/css" href="../css/tb_report.css">
</head>


```{r setup, echo= FALSE, message=FALSE,warning= FALSE}

# Strings ain't factors
options(stringsAsFactors = FALSE)

# Load the required libraries
library(knitr)
library(xtable)
library(RODBC)
library(plyr)
library(ggplot2)
library(scales)
library(gridExtra)
library(lubridate)
library(reshape2)


# Set default chunk options
opts_chunk$set(echo = FALSE,
               results = 'asis',
               message = FALSE,
               warning = FALSE,
               fig.width = 10,
               error = TRUE)


# Set up default print arguments for printing tables:
# xtable() makes data.frames more suitable for display
# format() converts all of the data.frame comments to character*;
# print() writes the xtable object to HTML

# *print() for xtable throws a tantrum over Date and POSIXct variables,
# so they have to be converted to character before printing 

dfprint <- function(df, printdigits = 2) {
    print(
        xtable(format(df, 
                      na.encode = FALSE, 
                      digits = printdigits, 
                      nsmall = printdigits), 
               align = c("l", "l", rep("c", ncol(df) - 1))
        ),
        type = "html",
        include.rownames = FALSE,
        NA.string = "-")
}


# Set period dates
start_date <- Sys.Date() - weeks(12)
stop_date <- Sys.Date()


# Set some default plot parameters
point_size <- 3
line_size <- 1.3
colorwheel <- c("#31A354", "#ADDD8E", "#F03B20", "#43A2CA")

theme_tb <- theme_bw() +
            theme(legend.key.width = unit(.75, "inches"))



# Set up the database connection
if(interactive()) { 
    plus <- odbcConnect("tbdbplus64") 
} else {
    plus <- odbcConnect("tbdbplus32")
}
    



```






# TB Clinic Daily Status Report
Updated at `r paste(Sys.time())`

---------------------------------

## Recent Clinic Visits

```{r visits}


source("../Quarterly Strategic Area Review//R//fun/query_visits.r")

visits <- query_visits(start_date = start_date,
                       stop_date = stop_date)

# Add a week indicator
visits$visit_week <- format(visits$visit_date, format = "%Y-%W")

# Aggregate by week
locagg <- ddply(subset(visits, location %in% c("Clinic", "Outreach")),
                .var = c("location", "visit_week"),
                .fun = summarise,
                n_visits = length(visit_date),
                week_date = as.Date(min(visit_date, na.rm = TRUE))
)


totals <- ddply(subset(visits, location %in% c("Clinic", "Outreach")),
                .var = "visit_week",
                .fun = summarise,
                n_visits = length(visit_date),
                week_date = as.Date(min(visit_date, na.rm = TRUE))
)


totals$location <- "All Visits"

visitagg <- rbind(locagg, totals)



ggplot(visitagg, aes(x = week_date, y = n_visits, group = location, color = location)) +
    geom_point(size = point_size) +
    geom_line(aes(linetype = location), size = line_size) +
    expand_limits(y = 0) +
    scale_color_manual("Visit Location", values = colorwheel[1:3]) +
    scale_x_date(breaks = date_breaks("1 week")) +
    scale_linetype_discrete("Visit Location") +
    labs(x = "Visit Week", 
         y = "Number of visits",
         title = "Patient Visits by Location") +
    theme_tb + theme(axis.text.x = element_text(angle = 70, hjust = 1.30, vjust = 1.3))



```


```{r, results='asis'}

# Cast visits wide
visits_wide <- dcast(visitagg, week_date ~ location, value.var = "n_visits")

# Pretty-print
names(visits_wide) <- c("Visit Week", "Total Visits", "Clinic Visits", "Outreach Visits")

dfprint(visits_wide)

```


-------------------------------------------
## Recent Screenings
```{r screens}

# Load the function
source("fun/query_tests.r")

# Query test results for the period
tests <- query_tests(start_date = start_date,
                     stop_date = stop_date)

# Convert date to quarter
tests$plot_qtr <- with(tests, paste(test_yr, " Q", test_qtr, sep = ""))

# Aggregate by quarter
testagg <- count(tests, vars = c("test", "plot_qtr"))


# Plot it
ggplot(testagg, aes(x = plot_qtr, y = freq, group = test, color = test)) +
    geom_point(size = point_size) +
    geom_line(aes(linetype = test), size = line_size) +
    expand_limits(y = 0) +
    scale_color_manual("Diagnostic", values = colorwheel[1:3]) +
    scale_linetype_discrete("Diagnostic") +
    labs(x = "Diagnostic date", 
         y = "Number of diagnostics",
         title = "Screenings for Active and Latent Tuberculosis") +
    theme_tb
```


```{r, results='asis'}

# Cast tests wide
tests_wide <- dcast(testagg, plot_qtr ~ test, value.var = "freq")

# Pretty-print
names(tests_wide) <- c("Quarter", "CXRs", "QFTs", "TSTs")

dfprint(tests_wide)

```



## Current Contact Investigations



## Patients currently receiving treatment for Active TB


## Patients currently receiving treatment for LTBI



## Upcoming DOTs


## Upcoming LTBI Pickups


## CXRs Awaiting Action


## Upcoming Eight-Week Sputa











```{r cleanup}

# Close the database connection
odbcClose(plus)


```




